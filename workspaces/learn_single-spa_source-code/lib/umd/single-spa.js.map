{"version":3,"file":"single-spa.js","sources":["../../src/start.js","../../src/applications/app.helpers.js","../../src/lifecycles/load.js","../../src/lifecycles/mount.js","../../src/lifecycles/unmount.js","../../src/lifecycles/bootstrap.js","../../src/navigations/navigation-events.js","../../src/navigations/reroute.js","../../src/applications/app.js"],"sourcesContent":["import { reroute } from \"./navigations/reroute\"\n\nexport let startedFlag = false\n\nexport function start() {\n  startedFlag = true\n  reroute()\n}\n","export const LIFECYCLE_ENUM = {\n  NOT_LOADED: 'NOT_LOADED',\n  LOADING_SOURCE_CODE: 'LOADING_SOURCE_CODE',\n  NOT_BOOTSTRAPPED: 'NOT_BOOTSTRAPPED',\n  BOOTSTRAPPING: 'BOOTSTRAPPING',\n  NOT_MOUNTED: 'NOT_MOUNTED',\n  MOUNTING: 'MOUNTING',\n  MOUNTED: 'MOUNTED',\n  UPDATING: 'UPDATING',\n  UNMOUNTING: 'UNMOUNTING',\n  UNLOADING: 'UNLOADING',\n  LOAD_ERR: 'LOAD_ERR',\n  SKIP_BECAUSE_BROKEN: 'SKIP_BECAUSE_BROKEN'\n}\n\nexport function isActive(app) {\n  return app.status === LIFECYCLE_ENUM.MOUNTED\n}\n\nexport function shouldBeActive(app) {\n  return app.activeWhen(window.location)\n}","import { LIFECYCLE_ENUM } from \"../applications/app.helpers\";\n\nfunction flatFnArray(fns) {\n  fns = Array.isArray(fns) ? fns : [fns]\n  return (props) => {\n    return fns.reduce(async (promise, fn) => {\n      return promise.then(() => fn(props))\n    }, Promise.resolve())\n  }\n}\n\nexport async function toLoadPromise(app) {\n  if (app.loadPromise) {\n    return app.loadPromise\n  }\n  return (app.loadPromise = Promise.resolve().then(async () => {\n    app.status = LIFECYCLE_ENUM.LOADING_SOURCE_CODE\n    const {\n      bootstrap,\n      mount,\n      unmount\n    } = await app.loadApp(app.customProps)\n    app.bootstrap = flatFnArray(bootstrap)\n    app.mount = flatFnArray(mount)\n    app.unmount = flatFnArray(unmount)\n    app.status = LIFECYCLE_ENUM.NOT_BOOTSTRAPPED\n    return app\n  }))\n}\n","import { LIFECYCLE_ENUM } from \"../applications/app.helpers\";\n\nexport async function toMountPromise(app) {\n  if (app.status !== LIFECYCLE_ENUM.NOT_MOUNTED) {\n    return app\n  }\n  app.status = LIFECYCLE_ENUM.MOUNTING\n  await app.mount(app.customProps)\n  app.status = LIFECYCLE_ENUM.MOUNTED\n  return app\n}\n","import { LIFECYCLE_ENUM } from \"../applications/app.helpers\";\n\nexport async function toUnmountPromise(app) {\n  if (app.status !== LIFECYCLE_ENUM.MOUNTED) {\n    return app\n  }\n  app.status = LIFECYCLE_ENUM.UNMOUNTING\n  await app.unmount(app.customProps)\n  app.status = LIFECYCLE_ENUM.NOT_MOUNTED\n  return app\n}\n","import { LIFECYCLE_ENUM } from \"../applications/app.helpers\";\n\nexport async function toBootstrapPromise(app) {\n  if (app.status !== LIFECYCLE_ENUM.NOT_BOOTSTRAPPED) {\n    return app\n  }\n  app.status = LIFECYCLE_ENUM.BOOTSTRAPPING\n  await app.bootstrap(app.customProps)\n  app.status = LIFECYCLE_ENUM.NOT_MOUNTED\n  return app\n}\n","import { reroute } from \"./reroute\";\n\nconst routingEventsListeningTo = ['hashchange', 'popstate']\n\n// 重新执行reroute\nfunction urlReroute() {\n  reroute()\n}\n// 劫持hashchange、popstate事件\nconst originAddEventListener = window.addEventListener\nconst originRemoveEventListener = window.removeEventListener\n\n// 被劫持的hashchange、popstate事件\nconst capturedEventListeners = {\n  hashchange: [],\n  popstate: []\n}\n\noriginAddEventListener('hashchange', urlReroute)\noriginAddEventListener('popstate', urlReroute)\n\nwindow.addEventListener = function(eventName, fn) {\n  // 是否eventName是hashchange、popstate\n  //   ? 进一步处理\n  //   : 调用originAddEventListener\n  if (routingEventsListeningTo.includes(eventName)) {\n    // 是否已经被劫持\n    //   ? 返回\n    //   : 保存至capturedEventListeners[eventName]\n    if (capturedEventListeners[eventName].includes[fn]) {\n      return\n    } else {\n      capturedEventListeners[eventName].push(fn)\n      return\n    }\n  }\n  return originAddEventListener.apply(this, arguments)\n}\nwindow.removeEventListener = function(eventName, fn) {\n  if (routingEventsListeningTo.includes(eventName)) {\n    if (capturedEventListeners[eventName].includes[fn]) {\n      return\n    } else {\n      capturedEventListeners[eventName] = capturedEventListeners[eventName].filter(item => item !== fn)\n      return\n    }\n  }\n  return originRemoveEventListener.apply(this, arguments)\n}\n\n// 劫持pushState、replaceState方法\nfunction patchedUpdateState(fn) {\n  return function() {\n    const preUrl = window.location.href\n    fn.apply(this, arguments)\n    const curUrl = window.location.href\n    // 如果url不一致，重新执行urlReroute\n    if (preUrl !== curUrl) {\n      urlReroute()\n    }\n  }\n}\n\nwindow.history.pushState = patchedUpdateState(window.history.pushState)\nwindow.history.replaceState = patchedUpdateState(window.history.replaceState)\n","import { getAppChanges } from \"../applications/app\";\nimport { startedFlag } from \"../start\";\nimport { toLoadPromise } from '../lifecycles/load'\nimport { toMountPromise } from \"../lifecycles/mount\";\nimport { toUnmountPromise } from \"../lifecycles/unmount\";\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\";\nimport './navigation-events'\n\nexport function reroute() {\n  const {\n    appsToLoad,\n    appsToMount,\n    appsToUnmount\n  } = getAppChanges()\n  if (startedFlag) {\n    return performanceChanges()\n  } else {\n    return loadApps()\n  }\n  async function performanceChanges() {\n    await appsToUnmount.map(toUnmountPromise)\n    appsToLoad.map(async app => {\n      await toLoadPromise(app)\n      await toBootstrapPromise(app)\n      await toMountPromise(app)\n    })\n    appsToMount.map(async app => {\n      await toMountPromise(app)\n    })\n  }\n  async function loadApps() {\n    const apps = await Promise.all(appsToLoad.map(toLoadPromise))\n    return apps\n  }\n}","import { reroute } from \"../navigations/reroute\"\nimport { LIFECYCLE_ENUM, shouldBeActive } from \"./app.helpers\"\n\nconst apps = []\n\nexport function registerApplication(appName, loadApp, activeWhen, customProps) {\n  apps.push({\n    appName,\n    loadApp,\n    activeWhen,\n    customProps,\n    status: LIFECYCLE_ENUM.NOT_LOADED\n  })\n  reroute()\n}\n\nexport function getAppChanges() {\n  const appsToUnmount = []\n  const appsToMount = []\n  const appsToLoad = []\n\n  apps.forEach(app => {\n    const shouldBeActiveFlag = shouldBeActive(app)\n    switch (app.status) {\n      case LIFECYCLE_ENUM.NOT_LOADED:\n      case LIFECYCLE_ENUM.LOADING_SOURCE_CODE:\n        if (shouldBeActiveFlag) {\n          appsToLoad.push(app)\n        }\n        break\n      case LIFECYCLE_ENUM.NOT_BOOTSTRAPPED:\n      case LIFECYCLE_ENUM.BOOTSTRAPPING:\n      case LIFECYCLE_ENUM.NOT_MOUNTED:\n        if (shouldBeActiveFlag) {\n          appsToMount.push(app)\n        }\n        break\n      case LIFECYCLE_ENUM.MOUNTED:\n        if (!shouldBeActiveFlag) {\n          appsToUnmount.push(app)\n        }\n    }\n  })\n\n  return {\n    appsToLoad,\n    appsToMount,\n    appsToUnmount\n  }\n}"],"names":[],"mappings":"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"}